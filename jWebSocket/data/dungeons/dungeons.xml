<?xml version="1.0" encoding="UTF-8"?>
<dungeons>
    <dungeon id="generic" size="256" cells="16" depth="5">
        <init>
            <![CDATA[
            var size = DIGGER.size;
            for (var y=0; y<size; y++) {
                for (var x=0; x<size; x++) {
                    DIGGER.digTile(x, y, DIGGER.depth, MAT_DIRT_BLOCK_0);
                }
            }
            ]]>
        </init>
        <build>
            <![CDATA[
            function shuffledCellsArray() {
                var cellsList = [];
                for (var i = 0; i < DIGGER.cellsnum * DIGGER.cellsnum; i++)
                    cellsList.push(i);
                utils.shuffle(cellsList);
                
                return cellsList;
            };
            
            //select and set a cell taken from cells array 
            function selectCell(cellsList) {
                var cellNumber = cellsList.pop();
                DIGGER.move(cellNumber%DIGGER.cellsnum, Math.floor(cellNumber/DIGGER.cellsnum), DIGGER.depth);
            };
            
            /* Primordial Age */
            
            //for every dungeon level roll N events
            for (var depth = 0; depth < DIGGER.dungeondepth; depth++) {
                
                DIGGER.toDepth(depth);
                var cellsList = shuffledCellsArray();
                var numPrimordialEvents = (DIGGER.cellsnum * DIGGER.cellsnum) / 4;
                
                for (var n = 0; n < numPrimordialEvents; n++) {
                    //select an event
                    var roll = DIGGER.randomI(0, 10); 
                    switch (roll) {
                    case 0:
                        selectCell(cellsList)
                         DIGGER.event('mineralvein', {});
                        break;
                    case 1:
                        selectCell(cellsList)
                         DIGGER.event('mineralvein', {});
                        break;
                    case 2:
                        selectCell(cellsList)
                         DIGGER.event('mineralvein', {});
                        break;
                    case 3:
                        selectCell(cellsList)
                         DIGGER.event('mineralvein', {});
                        break;
                    case 4:
                        selectCell(cellsList)
                         DIGGER.event('mineralvein', {});
                        break;
                    case 5:
                        selectCell(cellsList)
                         DIGGER.event('cavern', {});
                        break;
                    case 6:
                        selectCell(cellsList)
                         DIGGER.event('cavern', {});
                        break;
                    case 7:
                        selectCell(cellsList)
                         DIGGER.event('cavern', {});
                        break;
                    case 8:
                        selectCell(cellsList)
                         DIGGER.event('cavern', {});
                        break;
                    case 9:
                        selectCell(cellsList)
                         DIGGER.event('cavern', {});
                        break;
                    default:
                        break;
                    }
                }
            }
            
            //cleaning
            cellsList = undefined;
            
            /* The Age of Civilization (dwarven) */
            
            //build starting outpost
            var currentCoord = { x:0, y:0, depth:0 }
            currentCoord.x = 0;//DIGGER.randomI(0, DIGGER.numCellsPerSide());
            currentCoord.y = 0;//DIGGER.randomI(0, DIGGER.numCellsPerSide());
            
            DIGGER.move(currentCoord.x, currentCoord.y, currentCoord.depth);
            DIGGER.event('dwarvenstart', {});
            DIGGER.move(currentCoord.x + 1, currentCoord.y, currentCoord.depth);
            DIGGER.event('dwarvenstart', {});
            
            DIGGER.link(currentCoord.x, currentCoord.y, currentCoord.x + 1, currentCoord.y, MAT_DIRT_FLOOR_0, MAT_NOMATERIAL);
            
            /*
            DIGGER.initCellsIterator(0);
            while (DIGGER.nextCell()) {
                 var choose = DIGGER.randomI(0, 2);
                 if (choose == 0)
                     DIGGER.event('test', {});
            }
            */
            ]]>
        </build>
    </dungeon>
</dungeons>