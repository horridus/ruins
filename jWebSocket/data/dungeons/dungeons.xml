<?xml version="1.0" encoding="UTF-8"?>
<dungeons>
    <dungeon id="generic" size="256" cells="16" depth="5">
        <init>
            <![CDATA[
            var size = _dungeon_.size();
            for (var y=0; y<size; y++) {
                for (var x=0; x<size; x++) {
                    _digger_.digTile(x, y, _depth_, _mat_DIRT_BLOCK_0);
                }
            }
            ]]>
        </init>
        <build>
            <![CDATA[
            function shuffledCellsArray() {
                var cellsList = [];
                for (var i = 0; i < _digger_.numCellsPerSide()*_digger_.numCellsPerSide(); i++)
                    cellsList.push(i);
                utils.shuffle(cellsList);
                
                return cellsList;
            };
            
            //select and set a cell taken from cells array 
            function selectCell(cellsList) {
                var cellNumber = cellsList.pop();
                _digger_.setCurrentCell(cellNumber%_digger_.numCellsPerSide(), Math.floor(cellNumber/_digger_.numCellsPerSide()), _depth_);
            };
            
            /* Primordial Age */
            
            //for every dungeon level roll N events
            for (; _depth_ < _digger_.dungeonDepth(); _depth_++) {
                
                var cellsList = shuffledCellsArray();
                var numPrimordialEvents = _digger_.numCellsPerSide()*_digger_.numCellsPerSide()/4;
                
                for (var n = 0; n < numPrimordialEvents; n++) {
                    //select an event
                    var roll = _digger_.randomI(0, 10); 
                    switch (roll) {
                    case 0:
                        selectCell(cellsList)
                         _digger_.event('mineralvein', {});
                        break;
                    case 1:
                        selectCell(cellsList)
                         _digger_.event('mineralvein', {});
                        break;
                    case 2:
                        selectCell(cellsList)
                         _digger_.event('mineralvein', {});
                        break;
                    case 3:
                        selectCell(cellsList)
                         _digger_.event('mineralvein', {});
                        break;
                    case 4:
                        selectCell(cellsList)
                         _digger_.event('mineralvein', {});
                        break;
                    case 5:
                        selectCell(cellsList)
                         _digger_.event('cavern', {});
                        break;
                    case 6:
                        selectCell(cellsList)
                         _digger_.event('cavern', {});
                        break;
                    case 7:
                        selectCell(cellsList)
                         _digger_.event('cavern', {});
                        break;
                    case 8:
                        selectCell(cellsList)
                         _digger_.event('cavern', {});
                        break;
                    case 9:
                        selectCell(cellsList)
                         _digger_.event('cavern', {});
                        break;
                    default:
                        break;
                    }
                }
            }
            
            //cleaning
            cellsList = undefined;
            
            /* The Age of Civilization (dwarven) */
            
            //build starting outpost
            var currentCoord = { x:0, y:0, depth:0 }
            currentCoord.x = 0;//_digger_.randomI(0, _digger_.numCellsPerSide());
            currentCoord.y = 0;//_digger_.randomI(0, _digger_.numCellsPerSide());
            
            _digger_.setCurrentCell(currentCoord.x, currentCoord.y, currentCoord.depth);
            _digger_.event('dwarvenstart', {});
            
            /*
            _digger_.initCellsIterator(0);
            while (_digger_.nextCell()) {
                 var choose = _digger_.randomI(0, 2);
                 if (choose == 0)
                     _digger_.event('test', {});
            }
            */
            ]]>
        </build>
    </dungeon>
</dungeons>